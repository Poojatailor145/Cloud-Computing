<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!--=============== FLATICON ===============-->
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/uicons-regular-straight/css/uicons-regular-straight.css"
    />

    <!--=============== SWIPER CSS ===============-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />

    <!--=============== CSS ===============-->
    <link rel="stylesheet" href="css/styles.css" />

    <title>Coziture</title>
  </head>
  <body>
    <!--=============== HEADER ===============-->
    <header class="header">
      <nav class="nav container">
        <a href="index.html" class="nav__logo">
          <img src="images/logo.png" alt="" class="nav__logo-img" />
        </a>

        <div class="nav__menu" id="nav-menu">
          <ul class="nav__list">
            <li class="nav__item">
              <a href="index.html" class="nav__link ">Home</a>
            </li>

            <li class="nav__item">
              <a href="shop.html" class="nav__link active-link">Shop</a>
            </li>

            <li class="nav__item">
              <a href="accounts.html" class="nav__link">My Account</a>
            </li>
          </ul>
        </div>

        <div class="header__user-actions">
          <a href="cart.html" class="header__action-btn">
            <img src="images/icon-cart.svg" alt="" />
            <span class="count" id="cart-count">3</span>
          </a>
        </div>
      </nav>
    </header>

    <!--=============== MAIN ===============-->
    <main class="main">
      <!--=============== BREADCRUMB ===============-->
      <section class="breadcrumb">
        <div class="breadcrumb__list container">
          <a href="index.html" class="breadcrumb__link">Home</a>
          <span class="breadcrumb__link">></span>
          <span class="breadcrumb__link">Shop</span>
        </div>
      </section>

      <!--=============== SEARCH ===============-->
      <section class="search-bar container" style="margin-top: 30px;">
        <input
          type="text"
          id="search-input"
          class="form-input"
          placeholder="Search for products..."
        />
      </section>

      <!--=============== FILTERS ===============-->
      <section class="filters container">
        <div class="filters__group">
          <label for="category-filter" class="total__products"><span>Category: </span></label>
          <select id="category-filter" class="filter__select">
            <option value="">All Categories</option>
            <!-- Categories will be dynamically injected here -->
          </select>
        </div>

        <div class="filters__group">
          <label for="min-price" style="margin-right: 5px;" class="total__products"><span>Range: </span></label>
          <input type="number" id="min-price" placeholder="Min Price" />
          <span>-</span>
          <input type="number" id="max-price" placeholder="Max Price" />
        </div>

        <button id="apply-filters" class="btn btn--sm">Apply Filters</button>
      </section>

      <!--=============== PRODUCTS ===============-->
      <section class="products section--lg container">
        <p class="total__products">We found <span id="total-products-count">688</span> items for you!</p>

        <div class="products__container grid" id="product-list">
          <!-- Dynamic product items will be injected here -->
        </div>
      </section>
    </main>

    <!--=============== FOOTER ===============-->
    <footer class="footer container">
      <div class="footer__container grid">
        <div class="footer__content">
          <a href="index.html" class="footer__logo">
            <img src="images/logo.png" alt="" class="footer__logo-img" />
          </a>
          <h4 class="footer__subtitle">Contact</h4>
          <p class="footer__description">
            <span>Address:</span> 562 Konrad Duden Weg, Frankfurt, Germany
          </p>
          <p class="footer__description">
            <span>Phone:</span> 01588745454
          </p>
          <p class="footer__description">
            <span>Working Hours:</span> 10:00 - 18:00, Mon-Sat
          </p>
        </div>
      </div>
    </footer>

    <!--=============== SWIPER JS ===============-->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!--=============== MAIN JS ===============-->
    <script src="js/main.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let allCategories = [];
        let allProducts = [];

        // Fetching categories and populating the category filter
        fetch('http://localhost:5000/api/categories')
          .then(response => response.json())
          .then(categories => {
            allCategories = categories;
            populateCategoryFilter(categories);
          })
          .catch(error => {
            console.error("Error fetching categories:", error);
          });

        // Fetching product data from API and inserting it dynamically
        fetch('http://localhost:5000/api/products')
          .then(response => response.json())
          .then(products => {
            allProducts = products;
            displayProducts(allProducts);

            // Update total product count
            const totalCount = document.getElementById('total-products-count');
            totalCount.innerText = products.length;
          })
          .catch(error => {
            console.error("Error fetching products:", error);
          });

        // Function to display products
        function displayProducts(products) {
          const productContainer = document.getElementById('product-list');
          productContainer.innerHTML = '';
          products.forEach(product => {
            const productItem = document.createElement('div');
            productItem.classList.add('product__item');

            const categoryName = getCategoryName(product.categoryId);

            productItem.innerHTML = `
              <div class="product__banner">
                <a href="details.html?productId=${product.productId}" class="product__images">
                  <img src="images/${product.imageUrl}1.jpg" alt="${product.productName}" class="product__img default">
                </a>
              </div>
              <div class="product__content">
                <span class="product__category">${categoryName}</span>
                <a href="details.html"><h3 class="product__title">${product.productName}</h3></a>
                <div class="product__rating">
                  ${generateStars(product.basePrice)}
                </div>
                <div class="product__price flex">
                  <span class="new__price">€${product.basePrice}</span>
                  <span class="old__price">€${(product.basePrice * 1.2).toFixed(2)}</span>
                </div>
              </div>
            `;
            productContainer.appendChild(productItem);
          });
        }

        // Function to generate star rating (based on price)
        function generateStars(price) {
          const stars = Math.floor(price / 100);
          let starHtml = '';
          for (let i = 0; i < 5; i++) {
            starHtml += i < stars ? '<i class="fi fi-rs-star"></i>' : '<i class="fi fi-rs-star-empty"></i>';
          }
          return starHtml;
        }

        // Function to map categoryId to category name using the categories data
        function getCategoryName(categoryId) {
          const category = allCategories.find(cat => cat.categoryId === categoryId);
          return category ? category.categoryName : "Unknown Category";
        }

        // Populate the category filter dropdown
        function populateCategoryFilter(categories) {
          const categorySelect = document.getElementById('category-filter');

          categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.categoryName;
            option.textContent = category.categoryName;
            categorySelect.appendChild(option);
          });
        }

        // Filter products based on search input
        document.getElementById('search-input').addEventListener('input', function () {
          const searchTerm = this.value.toLowerCase();

          const filteredProducts = allProducts.filter(product => 
            product.productName.toLowerCase().includes(searchTerm)
          );

          displayProducts(filteredProducts);
          const totalCount = document.getElementById('total-products-count');
          totalCount.innerText = filteredProducts.length;
        });

        // Filter products by selected category and price range
        function filterProducts() {
          const categoryFilter = document.getElementById('category-filter').value;
          const minPrice = document.getElementById('min-price').value;
          const maxPrice = document.getElementById('max-price').value;

          let filteredProducts = allProducts;

          // Apply category filter
          if (categoryFilter) {
            filteredProducts = filteredProducts.filter(product => getCategoryName(product.categoryId) === categoryFilter);
          }

          // Apply price range filter
          if (minPrice) {
            filteredProducts = filteredProducts.filter(product => product.basePrice >= minPrice);
          }
          if (maxPrice) {
            filteredProducts = filteredProducts.filter(product => product.basePrice <= maxPrice);
          }

          displayProducts(filteredProducts);
          const totalCount = document.getElementById('total-products-count');
          totalCount.innerText = filteredProducts.length;
        }

        // Apply filters when the button is clicked
        document.getElementById('apply-filters').addEventListener('click', filterProducts);
      });
    </script>
  </body>
</html>
